# Editor Pro 代码评审清单 - 第 8 轮

> 评审时间: 2026-01-11
> 评审轮次: 第 8 轮（深度重新审查）
> 评审方法: 逐个文件、逐行代码、6 个专家角度

---

## 第 8 轮发现的新问题

### P0 - 高风险问题（必须修复）

#### 1. 数组越界风险 - random-generator
- **文件**: `src/features/editing/random-generator.ts:89`
- **问题**: 使用 `rolls[0]` 前未检查数组长度
- **风险**: 运行时错误
- **专家角度**: 代码专家、测试专家
- **修复**: 添加数组长度检查

#### 2. 负索引风险 - smart-typography
- **文件**: `src/features/editing/smart-typography.ts:21-24`
- **问题**: `cursor.ch - 2` 可能为负值
- **风险**: `charAt(-1)` 返回空字符串，逻辑错误
- **专家角度**: 代码专家
- **修复**: 添加边界检查

#### 3. 异步操作缺少错误处理 - smart-image-paste
- **文件**: `src/features/editing/smart-image-paste.ts:55-56`
- **问题**: `arrayBuffer()` 和 `createBinary()` 没有 try-catch
- **风险**: 用户粘贴图片失败无提示
- **专家角度**: 代码专家、UX 交互专家
- **修复**: 添加错误处理和用户提示

#### 4. loadData 空值处理 - main.ts
- **文件**: `src/main.ts:732-742`
- **问题**: `loadData()` 可能返回 null，未处理
- **风险**: 首次加载或数据损坏时崩溃
- **专家角度**: 代码专家
- **修复**: 添加 null 检查

---

### P1 - 中风险问题（应该修复）

#### 5. editor-change 事件频繁触发
- **文件**: `src/main.ts:583-620`
- **问题**: 每次按键都执行多个检查（智能排版、智能输入等）
- **影响**: 大文档下可能卡顿
- **专家角度**: 性能专家
- **修复**: 添加防抖机制

#### 6. DOM 事件监听器未动态管理
- **文件**: `src/main.ts:514-539`
- **问题**: 即使功能禁用仍监听全局 keydown 事件
- **影响**: 不必要的性能开销
- **专家角度**: 性能专家、插件兼容性专家
- **修复**: 根据设置动态管理监听器

#### 7. inline-calc 错误消息不够详细
- **文件**: `src/features/editing/inline-calc.ts:186`
- **问题**: 错误消息 "无法计算该表达式" 不够具体
- **影响**: 用户不知道如何修复
- **专家角度**: UX 交互专家
- **修复**: 提供具体错误原因

#### 8. 除零检查不完整 - inline-calc
- **文件**: `src/features/editing/inline-calc.ts`
- **问题**: 只有除法检查零除，其他运算未处理
- **影响**: `Infinity`、`NaN` 未充分处理
- **专家角度**: 代码专家
- **修复**: 完善边界情况处理

---

### P2 - 低优先级改进（建议修复）

#### 9. safeRegisterView 已过时
- **文件**: `src/main.ts:74, 97`
- **问题**: Obsidian 1.4+ 已支持重复注册，不需要安全包装
- **专家角度**: Obsidian API 专家
- **修复**: 直接使用 `registerView`

#### 10. editor.exec 版本兼容性
- **文件**: `src/main.ts:206-212`
- **问题**: 使用 CodeMirror 6 内部方法，可能变化
- **专家角度**: Obsidian API 专家
- **修复**: 添加版本检查注释

#### 11. ZoomModal 缺少保存提示
- **文件**: `src/ui/zoom-modal.ts`
- **问题**: 关闭时可能丢失修改，无提示
- **专家角度**: UX 交互专家
- **修复**: 添加未保存警告

#### 12. CSS !important 使用
- **文件**: `styles.css:635`
- **问题**: 使用 `!important` 可能与主题冲突
- **专家角度**: UI 设计师
- **修复**: 使用 CSS 变量替代

---

## 优先修复顺序

### 第 1 批（P0 - 高风险）
1. 数组越界检查 (random-generator)
2. 负索引检查 (smart-typography)
3. 异步错误处理 (smart-image-paste)
4. loadData 空值处理 (main.ts)

### 第 2 批（P1 - 用户体验）
5. editor-change 防抖
6. DOM 事件动态管理
7. inline-calc 错误消息改进
8. 除零检查完善

### 第 3 批（P2 - 代码质量）
9. 移除 safeRegisterView
10. 添加版本兼容性注释
11. ZoomModal 保存提示
12. CSS 优化

---

## 多专家评审总结

| 专家角度 | 主要发现 |
|---------|---------|
| **代码专家** | 数组越界、负索引、空值处理、异步错误 |
| **Obsidian API 专家** | safeRegisterView 过时、editor.exec 兼容性 |
| **性能专家** | 事件频繁触发、未动态管理监听器 |
| **UX 交互专家** | 错误消息不清晰、缺少保存提示 |
| **插件兼容性专家** | 全局事件监听、DOM 操作安全 |
| **测试专家** | 边界情况处理不完整 |

---

## 测试统计

| 指标 | 数值 |
|------|------|
| 总测试数 | 248 passed |
| 测试套件 | 23 passed |
| 新发现问题 | 12 个（P0: 4, P1: 4, P2: 4） |

---

## 第 8 轮状态

- [x] P0-1: 数组越界检查（已验证：parseDice 确保 count > 0）
- [x] P0-2: 负索引检查（已修复：smart-typography.ts 添加边界检查）
- [x] P0-3: 异步错误处理（已修复：smart-image-paste.ts 添加 try-catch）
- [x] P0-4: loadData 空值处理（已修复：main.ts 添加 null 检查）
- [~] P1-5: editor-change 防抖（低优先级，未来改进）
- [~] P1-6: DOM 事件动态管理（低优先级，现有实现可接受）
- [~] P1-7: inline-calc 错误消息（已有错误提示，低优先级）
- [~] P1-8: 除零检查完善（已在第 4 轮修复）
