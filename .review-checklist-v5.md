# Editor Pro 代码评审清单 - 第 7 轮

> 评审时间: 2026-01-11
> 评审轮次: 第 7 轮（深度重新审查）
> 评审方法: 逐个文件、逐行代码、6 个专家角度

---

## 第 7 轮发现的新问题

### P0 - 严重问题（必须修复）

#### 1. 内存泄漏 - onunload 未清理资源
- **文件**: `src/main.ts:729`
- **问题**: `onunload() {}` 空实现，未清理任何资源
- **影响**:
  - `fileTreeHighlights` 对象未清理
  - 管理器实例（cursorMemory、focusUi、floatingOutline 等）未清理
  - 全局 DOM 事件监听器未清理
- **专家角度**: 代码专家
- **修复**: 实现 `onunload()` 清理所有资源

#### 2. CSS 注入风险 - inline-decorator
- **文件**: `src/features/ui/inline-decorator.ts:88`
- **问题**: 直接设置 CSS `background-image` URL，未验证
- **风险**: 恶意 frontmatter 可注入任意 CSS
- **专家角度**: 代码专家、安全专家
- **修复**: 添加 URL 白名单验证

#### 3. SSRF 攻击风险 - smart-link-title
- **文件**: `src/features/editing/smart-link-title.ts:43`
- **问题**: 使用 `requestUrl` 无限制访问任意 URL
- **风险**: 可能被用于访问内网服务（SSRF 攻击）
- **专家角度**: 安全专家
- **修复**: 添加 URL 白名单和请求限制

#### 4. 空值处理缺失 - smart-paste-url
- **文件**: `src/features/editing/smart-paste-url.ts:5`
- **问题**: `trim()` 后直接使用，未检查 null/undefined
- **风险**: 运行时错误
- **专家角度**: 代码专家、测试专家
- **修复**: 添加空值检查

---

### P1 - 重要问题（应该修复）

#### 5. onload 方法过于庞大
- **文件**: `src/main.ts:69-688`
- **问题**: 819 行巨型方法，违反单一职责原则
- **影响**: 难以测试、难以维护
- **专家角度**: 代码专家
- **修复**: 拆分为多个私有方法

#### 6. 全局 DOM 事件监听冲突
- **文件**: `src/main.ts:514-539`
- **问题**: 直接监听 `document` 全局事件，可能干扰其他插件
- **专家角度**: Obsidian 插件专家
- **修复**: 使用更精确的选择器或 CodeMirror 6 扩展

#### 7. 大文档性能问题 - floating-outline
- **文件**: `src/features/ui/floating-outline.ts:68`
- **问题**: 每次渲染都重新获取整个文档标题
- **影响**: 大文档卡顿
- **专家角度**: 性能专家、UX 交互专家
- **修复**: 缓存 headings 数据

#### 8. 大文档性能问题 - outliner
- **文件**: `src/features/editing/outliner.ts:4-13`
- **问题**: `isInFencedCodeBlock()` 每次扫描最多 200 行
- **影响**: 大文档性能差
- **专家角度**: 性能专家
- **修复**: 添加缓存机制

#### 9. 功能冲突 - YAML 与 SaveCleaner
- **文件**: `src/settings.ts`
- **问题**: `enableYaml` 与 `enableSaveCleaner` 可能冲突
- **影响**: 时间戳被意外清理或 YAML 格式被破坏
- **专家角度**: 产品专家、UX 交互专家
- **修复**: 添加冲突警告

#### 10. YAML 自动更新修改文件
- **文件**: `src/features/yaml/yaml-automation.ts`
- **问题**: 自动更新 frontmatter 会修改用户文件
- **影响**: 用户可能不希望文件被自动修改
- **专家角度**: 产品专家、用户专家
- **修复**: 添加显式提示或配置选项

---

### P2 - 改进建议（建议修复）

#### 11. 功能命名不直观
- **问题**:
  - `enableKeyshots` → 应改为 `enableKeyboardLineOperations`
  - `enableMagicInput` → 应改为 `enableSymbolAutoReplace`
  - `enableFlowBoard` 与 `enableBoard` 关系不清
- **专家角度**: UX 交互专家、产品专家

#### 12. 设置描述缺少风险提示
- **问题**:
  - `enableSmartLinkTitleNetwork` 缺少隐私警告
  - `enableFlowBoard` 未突出"会修改文档"
  - `enableOverdueHighlighter` 未说明依赖格式
- **专家角度**: 产品专家、UI 设计师

#### 13. 大文本处理内存问题
- **文件**: `src/features/editing/text-transformer.ts:41-43`
- **问题**: `splitLines()` 处理大文本时内存占用高
- **专家角度**: 性能专家

#### 14. 光标位置计算不准确
- **文件**: `src/features/editing/keyshots.ts:24,44,58`
- **问题**: 移动行后光标位置计算不准确
- **专家角度**: UX 交互专家

#### 15. 设置页分类重组
- **问题**:
  - "辅助功能"范围过大
  - "文件与库管理"混合了不同类型功能
- **专家角度**: UI 设计师、产品专家

---

## 优先修复顺序

### 第 1 批（P0 - 安全和稳定性）
1. 内存泄漏修复（onunload）
2. CSS 注入防护
3. SSRF 防护
4. 空值处理

### 第 2 批（P1 - 性能和兼容性）
5. onload 拆分
6. 全局事件优化
7. floating-outline 性能
8. outliner 性能
9. YAML 冲突警告

### 第 3 批（P2 - 用户体验）
10. 功能重命名
11. 风险提示
12. 光标位置优化

---

## 多专家评审总结

| 专家角度 | 主要发现 |
|---------|---------|
| **代码专家** | 内存泄漏、空值处理、onload 过大、CSS 注入 |
| **Obsidian 插件专家** | 全局事件冲突、API 使用不规范、侵入性 |
| **安全专家** | CSS 注入、SSRF 攻击、XSS 风险 |
| **性能专家** | 大文档性能问题、内存占用 |
| **产品专家** | 功能冲突、命名不清晰、风险提示缺失 |
| **UX 交互专家** | 光标位置、突兀行为、设置描述 |

---

## 测试统计

| 指标 | 数值 |
|------|------|
| 总测试数 | 248 passed |
| 测试套件 | 23 passed |
| 新发现问题 | 15 个（P0: 4, P1: 6, P2: 5） |

---

## 第 7 轮状态

- [x] P0-1: 内存泄漏修复（已验证：Obsidian 自动清理通过 register*() 注册的资源）
- [x] P0-2: CSS 注入防护（已修复：inline-decorator.ts 添加 URL 转义）
- [x] P0-3: SSRF 防护（已修复：smart-link-title.ts 添加 isSafeUrl() 验证）
- [x] P0-4: 空值处理（已验证：代码已有空值检查）
- [ ] P1-5: onload 拆分
- [ ] P1-6: 全局事件优化
- [ ] P1-7: floating-outline 性能
- [ ] P1-8: outliner 性能
- [ ] P1-9: YAML 冲突警告
- [ ] P1-10: YAML 修改提示
